name: Auto-Merge Develop to Main

on:
  workflow_run:
    workflows: ["Test Suite"]
    types:
      - completed
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Create and Merge PR
    runs-on: ubuntu-latest
    # Only run if the test suite passed
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check for existing open PR from develop to main
          EXISTING_PR=$(gh pr list --head develop --base main --state open --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Found existing PR #$EXISTING_PR"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Create Pull Request
        if: steps.check_pr.outputs.pr_exists == 'false'
        id: create_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the latest commit message from develop
          COMMIT_MSG=$(git log -1 --pretty=%B origin/develop)

          # Create PR with auto-generated body
          PR_NUMBER=$(gh pr create \
            --title "Auto-merge: Develop to Main" \
            --body "$(cat <<'EOF'
          ## ü§ñ Automated Merge from Develop

          This PR was automatically created after all tests passed on the develop branch.

          ### ‚úÖ Test Results
          - All unit tests passed
          - All integration tests passed
          - Linting passed
          - Security scan passed

          ### üìù Latest Commit
          $COMMIT_MSG

          ### üîó Workflow Run
          https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}

          ---
          *This PR will be automatically merged if all checks pass.*
          EOF
          )" \
            --base main \
            --head develop \
            --label "automated" \
            | grep -o '[0-9]\+')

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Created PR #$PR_NUMBER"

      - name: Wait for PR checks
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number || steps.check_pr.outputs.pr_number }}"

          echo "Waiting for PR #$PR_NUMBER checks to complete..."

          # Wait up to 10 minutes for checks to complete
          TIMEOUT=600
          ELAPSED=0
          INTERVAL=10

          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Get PR status
            STATUS=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '.statusCheckRollup[] | select(.conclusion != null) | .conclusion' | sort -u)

            # Check if all checks have completed
            PENDING=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '.statusCheckRollup[] | select(.status == "IN_PROGRESS" or .status == "QUEUED") | .name' | wc -l)

            if [ "$PENDING" -eq 0 ]; then
              echo "All checks completed"
              break
            fi

            echo "Waiting for $PENDING checks to complete... (${ELAPSED}s elapsed)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

      - name: Auto-merge PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number || steps.check_pr.outputs.pr_number }}"

          echo "Attempting to merge PR #$PR_NUMBER..."

          # Check if PR is mergeable
          MERGEABLE=$(gh pr view "$PR_NUMBER" --json mergeable --jq '.mergeable')

          if [ "$MERGEABLE" != "MERGEABLE" ]; then
            echo "‚ùå PR is not mergeable (status: $MERGEABLE)"
            exit 1
          fi

          # Merge the PR using squash merge
          gh pr merge "$PR_NUMBER" \
            --squash \
            --auto \
            --delete-branch \
            --subject "Auto-merge: Develop to Main" \
            --body "All tests passed on develop branch. Auto-merged by GitHub Actions."

          echo "‚úÖ PR #$PR_NUMBER merged successfully"

      - name: Notify on failure
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number || steps.check_pr.outputs.pr_number }}"

          if [ -n "$PR_NUMBER" ]; then
            gh pr comment "$PR_NUMBER" --body "‚ö†Ô∏è Auto-merge failed. Please review and merge manually."
          fi
